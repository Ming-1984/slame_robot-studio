<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="acamana">

  <!-- Define some constants -->
  <xacro:property name="PI" value="3.1415926535897931"/>
  
  <!-- Get package path for meshes -->
  <xacro:property name="mesh_path" value="package://acamana/meshes/"/>

  <!-- Base Link -->
  <link name="base_link">
    <inertial>
      <origin xyz="-0.000410773784337879 -4.50102945727632E-06 0.000188079948723217" rpy="0 0 0" />
      <mass value="0.224252192432071" />
      <inertia
        ixx="0.000384367775648917"
        ixy="3.76312515381557E-08"
        ixz="-3.24905280224815E-09"
        iyy="0.00152650491504501"
        iyz="7.02452171299624E-11"
        izz="0.00189778395864725" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}base_link.STL" />
      </geometry>
      <material name="light_blue">
        <color rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}base_link.STL" />
      </geometry>
    </collision>
  </link>

  <!-- Left Steering Hinge -->
  <link name="left_steering_hinge">
    <inertial>
      <origin xyz="-0.00214055518577709 0.0114938412169271 -0.00101430442705201" rpy="0 0 0" />
      <mass value="0.019320077665136" />
      <inertia
        ixx="3.65091233921692E-06"
        ixy="-3.8359376652168E-07"
        ixz="-4.31566026293577E-07"
        iyy="4.40274174328948E-06"
        iyz="-1.57348260942121E-07"
        izz="4.35327403175562E-06" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}left_steering_hinge.STL" />
      </geometry>
      <material name="light_blue" />
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}left_steering_hinge.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="left_steering_hinge_joint" type="revolute">
    <origin xyz="0.11123 0.063711 -0.00033469" rpy="0 0 0" />
    <parent link="base_link" />
    <child link="left_steering_hinge" />
    <axis xyz="0 0 1" />
    <limit lower="-0.785" upper="0.785" effort="1999.9" velocity="348.9" />
  </joint>

  <!-- Left Front Wheel -->
  <link name="left_front_wheel">
    <inertial>
      <origin xyz="2.69864139146314E-07 0.000974501012028089 7.43504567637335E-08" rpy="0 0 0" />
      <mass value="0.124188351717402" />
      <inertia
        ixx="0.000108426219461981"
        ixy="6.16641829591181E-10"
        ixz="6.14953076918742E-09"
        iyy="0.000198988759881268"
        iyz="-1.79345986661271E-11"
        izz="0.000108425295656723" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}left_front_wheel.STL" />
      </geometry>
      <material name="wheel_material">
        <color rgba="0.2 0.2 0.2 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}left_front_wheel.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="left_front_wheel_joint" type="continuous">
    <origin xyz="0 0.047063 0" rpy="0 0 0" />
    <parent link="left_steering_hinge" />
    <child link="left_front_wheel" />
    <axis xyz="0 -1 0" />
    <limit effort="259.9" velocity="529.9" />
  </joint>

  <!-- Right Steering Hinge -->
  <link name="right_steering_hinge">
    <inertial>
      <origin xyz="-0.00214065668285346 -0.0114939743395863 -0.00101615028127726" rpy="0 0 0" />
      <mass value="0.0193185139789688" />
      <inertia
        ixx="3.6507224134391E-06"
        ixy="3.83677614862953E-07"
        ixz="-4.31474916495668E-07"
        iyy="4.40170253054901E-06"
        iyz="1.57666090581151E-07"
        izz="4.3530528940828E-06" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}right_steering_hinge.STL" />
      </geometry>
      <material name="light_blue" />
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}right_steering_hinge.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="right_steering_hinge_joint" type="revolute">
    <origin xyz="0.11123 -0.063711 -0.00033469" rpy="0 0 0" />
    <parent link="base_link" />
    <child link="right_steering_hinge" />
    <axis xyz="0 0 1" />
    <limit lower="-0.785" upper="0.785" effort="1999.9" velocity="348.9" />
  </joint>

  <!-- Right Front Wheel -->
  <link name="right_front_wheel">
    <inertial>
      <origin xyz="-1.550417727883E-06 -0.000974395825432128 2.48294778512344E-06" rpy="0 0 0" />
      <mass value="0.124186468008551" />
      <inertia
        ixx="0.0001084386658304"
        ixy="8.2849214966896E-10"
        ixz="2.08769584709537E-08"
        iyy="0.000199003281991997"
        iyz="1.53854417197541E-09"
        izz="0.00010842819433505" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}right_front_wheel.STL" />
      </geometry>
      <material name="wheel_material">
        <color rgba="0.2 0.2 0.2 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}right_front_wheel.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="right_front_wheel_joint" type="continuous">
    <origin xyz="0 -0.047063 0" rpy="0 0 0" />
    <parent link="right_steering_hinge" />
    <child link="right_front_wheel" />
    <axis xyz="0 -1 0" />
    <limit effort="259.9" velocity="529.9" />
  </joint>

  <!-- Left Rear Wheel -->
  <link name="left_rear_wheel">
    <inertial>
      <origin xyz="1.48678928679757E-06 0.000974279188147756 -2.39603507424775E-06" rpy="0 0 0" />
      <mass value="0.124185768823433" />
      <inertia
        ixx="0.000108447186828646"
        ixy="9.3356109022442E-10"
        ixz="-7.51084978124662E-09"
        iyy="0.000198999670249457"
        iyz="2.67909684507298E-10"
        izz="0.000108415507605727" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}left_rear_wheel.STL" />
      </geometry>
      <material name="wheel_material">
        <color rgba="0.2 0.2 0.2 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}left_rear_wheel.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="left_rear_wheel_joint" type="continuous">
    <origin xyz="-0.10277 0.063711 -0.00033469" rpy="0 0 0" />
    <parent link="base_link" />
    <child link="left_rear_wheel" />
    <axis xyz="0 -1 0" />
    <limit effort="259.9" velocity="529.9" />
  </joint>

  <!-- Right Rear Wheel -->
  <link name="right_rear_wheel">
    <inertial>
      <origin xyz="1.46938456827378E-06 -0.000974279188147756 -2.39603507424775E-06" rpy="0 0 0" />
      <mass value="0.124185768823433" />
      <inertia
        ixx="0.000108447186828646"
        ixy="-9.3356109022442E-10"
        ixz="-7.51084978124662E-09"
        iyy="0.000198999670249457"
        iyz="-2.67909684507298E-10"
        izz="0.000108415507605727" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}right_rear_wheel.STL" />
      </geometry>
      <material name="wheel_material">
        <color rgba="0.2 0.2 0.2 1" />
      </material>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}right_rear_wheel.STL" />
      </geometry>
    </collision>
  </link>

  <joint name="right_rear_wheel_joint" type="continuous">
    <origin xyz="-0.10277 -0.063711 -0.00033469" rpy="0 0 0" />
    <parent link="base_link" />
    <child link="right_rear_wheel" />
    <axis xyz="0 -1 0" />
    <limit effort="259.9" velocity="529.9" />
  </joint>

  <!-- Ignition Gazebo plugins and materials -->
  
  <!-- Base Link Ignition Properties -->
  <gazebo reference="base_link">
    <material>
      <ambient>0.792 0.819 0.933 1</ambient>
      <diffuse>0.792 0.819 0.933 1</diffuse>
      <specular>0.1 0.1 0.1 1</specular>
    </material>
    <mu1>0.2</mu1>
    <mu2>0.2</mu2>
    <self_collide>true</self_collide>
  </gazebo>

  <!-- Steering Hinge Properties -->
  <gazebo reference="left_steering_hinge">
    <material>
      <ambient>0.792 0.819 0.933 1</ambient>
      <diffuse>0.792 0.819 0.933 1</diffuse>
      <specular>0.1 0.1 0.1 1</specular>
    </material>
  </gazebo>

  <gazebo reference="right_steering_hinge">
    <material>
      <ambient>0.792 0.819 0.933 1</ambient>
      <diffuse>0.792 0.819 0.933 1</diffuse>
      <specular>0.1 0.1 0.1 1</specular>
    </material>
  </gazebo>

  <!-- Wheel Properties -->
  <gazebo reference="left_front_wheel">
    <material>
      <ambient>0.2 0.2 0.2 1</ambient>
      <diffuse>0.2 0.2 0.2 1</diffuse>
      <specular>0.1 0.1 0.1 1</specular>
    </material>
    <mu1>1.0</mu1>
    <mu2>1.0</mu2>
    <kp>500000.0</kp>
    <kd>10.0</kd>
    <min_depth>0.001</min_depth>
    <max_vel>0.1</max_vel>
  </gazebo>

  <gazebo reference="right_front_wheel">
    <material>
      <ambient>0.2 0.2 0.2 1</ambient>
      <diffuse>0.2 0.2 0.2 1</diffuse>
      <specular>0.1 0.1 0.1 1</specular>
    </material>
    <mu1>1.0</mu1>
    <mu2>1.0</mu2>
    <kp>500000.0</kp>
    <kd>10.0</kd>
    <min_depth>0.001</min_depth>
    <max_vel>0.1</max_vel>
  </gazebo>

  <gazebo reference="left_rear_wheel">
    <material>
      <ambient>0.2 0.2 0.2 1</ambient>
      <diffuse>0.2 0.2 0.2 1</diffuse>
      <specular>0.1 0.1 0.1 1</specular>
    </material>
    <mu1>1.0</mu1>
    <mu2>1.0</mu2>
    <kp>500000.0</kp>
    <kd>10.0</kd>
    <min_depth>0.001</min_depth>
    <max_vel>0.1</max_vel>
  </gazebo>

  <gazebo reference="right_rear_wheel">
    <material>
      <ambient>0.2 0.2 0.2 1</ambient>
      <diffuse>0.2 0.2 0.2 1</diffuse>
      <specular>0.1 0.1 0.1 1</specular>
    </material>
    <mu1>1.0</mu1>
    <mu2>1.0</mu2>
    <kp>500000.0</kp>
    <kd>10.0</kd>
    <min_depth>0.001</min_depth>
    <max_vel>0.1</max_vel>
  </gazebo>

  <!-- Ignition Gazebo Ackermann Drive Plugin -->
  <gazebo>
    <plugin filename="ignition-gazebo-ackermann-steering-system" name="ignition::gazebo::systems::AckermannSteering">
      <!-- Vehicle configuration -->
      <front_left_joint>left_front_wheel_joint</front_left_joint>
      <front_right_joint>right_front_wheel_joint</front_right_joint>
      <rear_left_joint>left_rear_wheel_joint</rear_left_joint>
      <rear_right_joint>right_rear_wheel_joint</rear_right_joint>
      
      <!-- Steering joints -->
      <left_steering_joint>left_steering_hinge_joint</left_steering_joint>
      <right_steering_joint>right_steering_hinge_joint</right_steering_joint>
      
      <!-- Wheel separation and wheelbase -->
      <wheel_separation>0.127422</wheel_separation>
      <kingpin_width>0.127422</kingpin_width>
      <wheelbase>0.21333</wheelbase>
      <wheel_radius>0.05</wheel_radius>
      
      <!-- Steering limits -->
      <steering_limit>0.785</steering_limit>
      
      <!-- Topics -->
      <topic>/acamana/cmd_vel</topic>
      <odom_topic>/acamana/odom</odom_topic>
      <tf_topic>/tf</tf_topic>
      
      <!-- Frame IDs -->
      <frame_id>odom</frame_id>
      <child_frame_id>base_link</child_frame_id>
      
      <!-- Update rate -->
      <update_rate>100</update_rate>
      
      <!-- Publish odometry -->
      <publish_odom>true</publish_odom>
      <publish_odom_tf>true</publish_odom_tf>
      <publish_wheel_tf>false</publish_wheel_tf>
    </plugin>
  </gazebo>

  <!-- Joint State Publisher Plugin for Ignition -->
  <gazebo>
    <plugin filename="ignition-gazebo-joint-state-publisher-system" name="ignition::gazebo::systems::JointStatePublisher">
      <topic>/joint_states</topic>
      <update_rate>30</update_rate>
      <joint_name>left_steering_hinge_joint</joint_name>
      <joint_name>right_steering_hinge_joint</joint_name>
      <joint_name>left_front_wheel_joint</joint_name>
      <joint_name>right_front_wheel_joint</joint_name>
      <joint_name>left_rear_wheel_joint</joint_name>
      <joint_name>right_rear_wheel_joint</joint_name>
    </plugin>
  </gazebo>

  <!-- Pose Publisher Plugin -->
  <gazebo>
    <plugin filename="ignition-gazebo-pose-publisher-system" name="ignition::gazebo::systems::PosePublisher">
      <publish_link_pose>true</publish_link_pose>
      <publish_collision_pose>false</publish_collision_pose>
      <publish_visual_pose>false</publish_visual_pose>
      <use_pose_vector_msg>true</use_pose_vector_msg>
      <static_publisher>true</static_publisher>
      <static_update_frequency>1</static_update_frequency>
    </plugin>
  </gazebo>

</robot> 