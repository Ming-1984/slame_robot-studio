#!/bin/bash

# Robot Studio ç³»ç»Ÿç®¡ç†å™¨
# ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç½‘ç»œæœåŠ¡ã€ç›‘æ§ã€WiFiçƒ­ç‚¹ç­‰åŠŸèƒ½

# ç‰ˆæœ¬ä¿¡æ¯
VERSION="2.0.0"
SCRIPT_DIR="/home/jetson/ros2_ws"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'  
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# æ˜¾ç¤ºbanner
show_banner() {
    echo -e "${PURPLE}${BOLD}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                     ğŸ¤– Robot Studio                         â•‘"
    echo "â•‘                   ç³»ç»Ÿç®¡ç†æ§åˆ¶å° v$VERSION                    â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    show_banner
    echo -e "${CYAN}ä½¿ç”¨æ–¹æ³•:${NC}"
    echo "  $0 <command> [options]"
    echo ""
    echo -e "${CYAN}å¯ç”¨å‘½ä»¤:${NC}"
    echo ""
    echo -e "${YELLOW}æœåŠ¡ç®¡ç†:${NC}"
    echo "  start [--daemon]     å¯åŠ¨æ‰€æœ‰ç½‘ç»œæœåŠ¡å’Œåº•ç›˜æ§åˆ¶"
    echo "  start --hotspot      ï¼ˆå¯é€‰ï¼‰æ‰‹åŠ¨å¯åŠ¨WiFiçƒ­ç‚¹æ¨¡å¼"
    echo "  stop                 åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart              é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  status               æ˜¾ç¤ºæœåŠ¡çŠ¶æ€"
    echo ""
    echo -e "${YELLOW}ç½‘ç»œç®¡ç†:${NC}"
    echo "  network              æ˜¾ç¤ºç½‘ç»œçŠ¶æ€"
    echo "  hotspot              å¯ç”¨WiFiçƒ­ç‚¹"
    echo "  hotspot-stop         åœæ­¢WiFiçƒ­ç‚¹"
    echo ""
    echo -e "${YELLOW}ç›‘æ§ç®¡ç†:${NC}"
    echo "  monitor start        å¯åŠ¨æœåŠ¡ç›‘æ§"
    echo "  monitor stop         åœæ­¢æœåŠ¡ç›‘æ§"
    echo "  monitor status       ç›‘æ§çŠ¶æ€"
    echo ""
    echo -e "${YELLOW}ç³»ç»Ÿæ“ä½œ:${NC}"
    echo "  logs                 æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—"
    echo "  health               ç³»ç»Ÿå¥åº·æ£€æŸ¥"
    echo "  cleanup              æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
    echo "  version              æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  $0 start --daemon    # åå°å¯åŠ¨æ‰€æœ‰æœåŠ¡"
    echo "  $0 hotspot           # å¯ç”¨WiFiçƒ­ç‚¹"
    echo "  $0 monitor start     # å¯åŠ¨æœåŠ¡ç›‘æ§"
    echo "  $0 health            # æ‰§è¡Œå¥åº·æ£€æŸ¥"
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    local missing_deps=()

    # æ£€æŸ¥å…³é”®è„šæœ¬ï¼ˆåªæ£€æŸ¥å®é™…ä½¿ç”¨çš„è„šæœ¬ï¼‰
    for script in "improved_hotspot.sh" "service_monitor.sh" "network_manager.sh"; do
        if [ ! -x "$SCRIPT_DIR/$script" ]; then
            missing_deps+=("$script")
        fi
    done

    # æ£€æŸ¥ROS2ç¯å¢ƒ
    if [ ! -f "/opt/ros/humble/setup.bash" ]; then
        missing_deps+=("ROS2 Humble")
    fi

    if [ ${#missing_deps[@]} -gt 0 ]; then
        echo -e "${RED}âŒ ç¼ºå°‘ä¾èµ–:${NC}"
        for dep in "${missing_deps[@]}"; do
            echo "  - $dep"
        done
        return 1
    fi

    return 0
}

# å¯åŠ¨åº•ç›˜æ§åˆ¶èŠ‚ç‚¹
start_robot_control() {
    echo -e "${BLUE}ğŸ¤– å¯åŠ¨æœºå™¨äººåº•ç›˜æ§åˆ¶èŠ‚ç‚¹...${NC}"

    # è®¾ç½®ROS2ç¯å¢ƒ
    export ROS_DOMAIN_ID=99
    source /opt/ros/humble/setup.bash 2>/dev/null || true
    source "$SCRIPT_DIR/install/setup.bash" 2>/dev/null || true
    export LD_LIBRARY_PATH=/home/jetson/ros2_ws/src/aurora_remote_public/lib/linux_aarch64:$LD_LIBRARY_PATH

    # åˆ›å»ºæ—¥å¿—ç›®å½•ï¼ˆä½¿ç”¨ç”¨æˆ·ç›®å½•é¿å…æƒé™é—®é¢˜ï¼‰
    LOG_DIR="$HOME/.robot-studio/logs"
    mkdir -p "$LOG_DIR"

    # 1. å¯åŠ¨æœºå™¨äººæè¿°å‘å¸ƒå™¨
    echo "  å¯åŠ¨æœºå™¨äººæè¿°å‘å¸ƒå™¨..."
    if pgrep -f "robot_static_tf.launch.py" > /dev/null 2>&1; then
        local existing_pid
        existing_pid=$(pgrep -f "robot_static_tf.launch.py" | head -n 1)
        echo "    âœ… å·²åœ¨è¿è¡Œ (PID: $existing_pid)"
    else
        nohup ros2 launch acamana robot_static_tf.launch.py use_sim_time:=false > "$LOG_DIR/robot_model.log" 2>&1 &
        local pid1=$!
        sleep 2
        if ps -p $pid1 > /dev/null; then
            echo "    âœ… å·²å¯åŠ¨ (PID: $pid1)"
        else
            echo "    âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/robot_model.log"
        fi
    fi

    # 2. å¯åŠ¨ç»Ÿä¸€é˜¿å…‹æ›¼æ§åˆ¶å™¨
    echo "  å¯åŠ¨ç»Ÿä¸€é˜¿å…‹æ›¼æ§åˆ¶å™¨..."
    cd "$SCRIPT_DIR"
    if pgrep -f "unified_ackermann_controller.py" > /dev/null 2>&1; then
        local existing_pid
        existing_pid=$(pgrep -f "unified_ackermann_controller.py" | head -n 1)
        echo "    âœ… å·²åœ¨è¿è¡Œ (PID: $existing_pid)"
    else
        nohup python3 src/ackermann_controller/scripts/unified_ackermann_controller.py > "$LOG_DIR/ackermann_controller.log" 2>&1 &
        local pid2=$!
        sleep 2
        if ps -p $pid2 > /dev/null; then
            echo "    âœ… å·²å¯åŠ¨ (PID: $pid2)"
        else
            echo "    âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/ackermann_controller.log"
        fi
    fi

    # 3. å¯åŠ¨è¯é¢˜ä¸­ç»§èŠ‚ç‚¹
    echo "  å¯åŠ¨è¯é¢˜ä¸­ç»§èŠ‚ç‚¹..."
    if pgrep -f "topic_relay_node.py" > /dev/null 2>&1; then
        local existing_pid
        existing_pid=$(pgrep -f "topic_relay_node.py" | head -n 1)
        echo "    âœ… å·²åœ¨è¿è¡Œ (PID: $existing_pid)"
    else
        nohup python3 src/acamana/scripts/topic_relay_node.py > "$LOG_DIR/topic_relay.log" 2>&1 &
        local pid3=$!
        sleep 2
        if ps -p $pid3 > /dev/null; then
            echo "    âœ… å·²å¯åŠ¨ (PID: $pid3)"
        else
            echo "    âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/topic_relay.log"
        fi
    fi

    # 4. å¯åŠ¨ç¡¬ä»¶æ¥å£
    echo "  å¯åŠ¨ç¡¬ä»¶æ¥å£..."
    if pgrep -f "hardware_interface.launch.py" > /dev/null 2>&1; then
        local existing_pid
        existing_pid=$(pgrep -f "hardware_interface.launch.py" | head -n 1)
        echo "    âœ… å·²åœ¨è¿è¡Œ (PID: $existing_pid)"
    else
        nohup ros2 launch hardware_interface hardware_interface.launch.py min_speed:=0.0 > "$LOG_DIR/hardware_interface.log" 2>&1 &
        local pid4=$!
        sleep 3
        if ps -p $pid4 > /dev/null; then
            echo "    âœ… å·²å¯åŠ¨ (PID: $pid4)"
        else
            echo "    âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/hardware_interface.log"
        fi
    fi

    echo -e "${GREEN}âœ… åº•ç›˜æ§åˆ¶èŠ‚ç‚¹å¯åŠ¨å®Œæˆ${NC}"
    echo -e "${CYAN}   æ—¥å¿—ç›®å½•: $LOG_DIR${NC}"
}

# å¯åŠ¨SLAMç›¸å…³èŠ‚ç‚¹ï¼ˆå¿«é€Ÿç‰ˆæœ¬ï¼‰
start_slam_nodes() {
    echo -e "${BLUE}ğŸ—ºï¸ å¯åŠ¨SLAMå’Œä¼ æ„Ÿå™¨èŠ‚ç‚¹...${NC}"

    # è®¾ç½®ç¯å¢ƒå˜é‡
    export ROS_DOMAIN_ID=99
    source /opt/ros/humble/setup.bash 2>/dev/null || true
    source "$SCRIPT_DIR/install/setup.bash" 2>/dev/null || true
    export LD_LIBRARY_PATH=/home/jetson/ros2_ws/src/aurora_remote_public/lib/linux_aarch64:$LD_LIBRARY_PATH

    # åˆ›å»ºæ—¥å¿—ç›®å½•
    LOG_DIR="$HOME/.robot-studio/logs"
    mkdir -p "$LOG_DIR"

    # 1. å¯åŠ¨Aurora SDKæœåŠ¡å™¨ (LIDARæ•°æ®æº)
    echo "  å¯åŠ¨Aurora SDKæœåŠ¡å™¨..."
    cd "$SCRIPT_DIR"
    if pgrep -f "slamware_ros_sdk_server_node.py" > /dev/null 2>&1; then
        local existing_pid
        existing_pid=$(pgrep -f "slamware_ros_sdk_server_node.py" | head -n 1)
        echo "    âœ… å·²åœ¨è¿è¡Œ (PID: $existing_pid)"
    else
        nohup ros2 launch slamware_ros_sdk slamware_ros_sdk_server_node.py ip_address:=192.168.11.1 > "$LOG_DIR/aurora_sdk.log" 2>&1 &
        local pid=$!

        # å¿«é€Ÿå¯åŠ¨ï¼šåªç­‰å¾…3ç§’ï¼Œä¸è¿›è¡Œè¯¦ç»†éªŒè¯
        sleep 3
        if ps -p $pid > /dev/null; then
            echo "    âœ… å·²å¯åŠ¨ (PID: $pid)"
        else
            echo "    âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/aurora_sdk.log"
        fi
    fi

    echo -e "${GREEN}âœ… SLAMèŠ‚ç‚¹å¯åŠ¨å®Œæˆ${NC}"
}

# å¯åŠ¨WebæœåŠ¡å’ŒWebSocketæ¡¥æ¥ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
start_web_services() {
    echo -e "${BLUE}ğŸŒ å¯åŠ¨WebæœåŠ¡å’ŒWebSocketæ¡¥æ¥...${NC}"

    cd "$SCRIPT_DIR"

    # åˆ›å»ºæ—¥å¿—ç›®å½•
    LOG_DIR="$HOME/.robot-studio/logs"
    mkdir -p "$LOG_DIR"

    # 1. å¯åŠ¨APIæœåŠ¡å™¨ï¼ˆä½¿ç”¨bash -cç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®ä¼ é€’ï¼‰
    echo "  å¯åŠ¨APIæœåŠ¡å™¨..."
    if pgrep -f "python3 robot_api_server.py" > /dev/null 2>&1; then
        local existing_pid
        existing_pid=$(pgrep -f "python3 robot_api_server.py" | head -n 1)
        echo "    âœ… å·²åœ¨è¿è¡Œ (PID: $existing_pid)"
    else
        nohup bash -c "
            export ROS_DOMAIN_ID=99
            source /opt/ros/humble/setup.bash 2>/dev/null || true
            source $SCRIPT_DIR/install/setup.bash 2>/dev/null || true
            export LD_LIBRARY_PATH=/home/jetson/ros2_ws/src/aurora_remote_public/lib/linux_aarch64:\$LD_LIBRARY_PATH
            cd $SCRIPT_DIR
            python3 robot_api_server.py
        " > "$LOG_DIR/api_server.log" 2>&1 &

        local api_pid=$!
        sleep 3

        # éªŒè¯APIæœåŠ¡å™¨å¯åŠ¨
        if ps -p $api_pid > /dev/null 2>&1; then
            echo "    âœ… å·²å¯åŠ¨ (PID: $api_pid)"
        else
            echo "    âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/api_server.log"
            tail -10 "$LOG_DIR/api_server.log" | sed 's/^/       /'
        fi
    fi

    # 2. å¯åŠ¨WebæœåŠ¡å™¨
    echo "  å¯åŠ¨WebæœåŠ¡å™¨..."
    if pgrep -f "[w]eb_interface_server.py.*--port 8080" > /dev/null 2>&1 || \
       pgrep -f "[p]ython3 -m http.server.*8080" > /dev/null 2>&1; then
        local existing_pid
        existing_pid=$(pgrep -f "[w]eb_interface_server.py.*--port 8080" | head -n 1)
        if [ -z "$existing_pid" ]; then
            existing_pid=$(pgrep -f "[p]ython3 -m http.server.*8080" | head -n 1)
        fi
        echo "    âœ… å·²åœ¨è¿è¡Œ (PID: $existing_pid)"
    elif lsof -i :8080 >/dev/null 2>&1; then
        local port_pid
        local port_cmd
        port_pid=$(lsof -t -i :8080 2>/dev/null | head -n 1)
        port_cmd=$(ps -p "$port_pid" -o cmd= 2>/dev/null || true)
        echo "    âŒ å¯åŠ¨å¤±è´¥ï¼Œç«¯å£ 8080 å·²è¢«å ç”¨ (PID: $port_pid)"
        if [ -n "$port_cmd" ]; then
            echo "       $port_cmd"
        fi
        echo "       è¯·å…ˆé‡Šæ”¾ç«¯å£æˆ–æ‰§è¡Œ: ./robot-studio stop"
    else
        nohup python3 "$SCRIPT_DIR/web_interface_server.py" --bind 0.0.0.0 --port 8080 --directory "$SCRIPT_DIR/web_interface" > "$LOG_DIR/web_server.log" 2>&1 &
        local web_pid=$!
        sleep 1

        if ps -p $web_pid > /dev/null 2>&1; then
            echo "    âœ… å·²å¯åŠ¨ (PID: $web_pid)"
        else
            echo "    âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/web_server.log"
            tail -10 "$LOG_DIR/web_server.log" | sed 's/^/       /'
        fi
    fi

    # 3. å¯åŠ¨WebSocketæ¡¥æ¥ï¼ˆä½¿ç”¨bash -cç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®ä¼ é€’ï¼‰
    echo "  å¯åŠ¨WebSocketæ¡¥æ¥..."
    if pgrep -f "python3 ros2_web_bridge.py" > /dev/null 2>&1; then
        local existing_pid
        existing_pid=$(pgrep -f "python3 ros2_web_bridge.py" | head -n 1)
        echo "    âœ… å·²åœ¨è¿è¡Œ (PID: $existing_pid)"
    else
        nohup bash -c "
            export ROS_DOMAIN_ID=99
            source /opt/ros/humble/setup.bash 2>/dev/null || true
            source $SCRIPT_DIR/install/setup.bash 2>/dev/null || true
            export LD_LIBRARY_PATH=/home/jetson/ros2_ws/src/aurora_remote_public/lib/linux_aarch64:\$LD_LIBRARY_PATH
            cd $SCRIPT_DIR

            while true; do
                echo \"[\$(date)] å¯åŠ¨WebSocketæ¡¥æ¥æœåŠ¡...\" >> $LOG_DIR/websocket.log
                python3 ros2_web_bridge.py >> $LOG_DIR/websocket.log 2>&1
                exit_code=\$?
                echo \"[\$(date)] WebSocketæ¡¥æ¥æœåŠ¡é€€å‡ºï¼Œé€€å‡ºç : \$exit_code\" >> $LOG_DIR/websocket.log

                if [ \$exit_code -eq 0 ]; then
                    echo \"[\$(date)] WebSocketæ¡¥æ¥æœåŠ¡æ­£å¸¸é€€å‡º\" >> $LOG_DIR/websocket.log
                    break
                else
                    echo \"[\$(date)] WebSocketæ¡¥æ¥æœåŠ¡å¼‚å¸¸é€€å‡ºï¼Œ5ç§’åé‡å¯...\" >> $LOG_DIR/websocket.log
                    sleep 5
                fi
            done
        " > /dev/null 2>&1 &

        sleep 2

        # éªŒè¯WebSocketæ¡¥æ¥å¯åŠ¨
        if pgrep -f "python3 ros2_web_bridge.py" > /dev/null; then
            local ws_pid
            ws_pid=$(pgrep -f "python3 ros2_web_bridge.py" | head -n 1)
            echo "    âœ… å·²å¯åŠ¨ (PID: $ws_pid)"
        else
            echo "    âŒ å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—: tail -f $LOG_DIR/websocket.log"
            tail -10 "$LOG_DIR/websocket.log" 2>/dev/null | sed 's/^/       /'
        fi
    fi

    echo -e "${GREEN}âœ… WebæœåŠ¡å¯åŠ¨å®Œæˆ${NC}"
    echo -e "${CYAN}   æ—¥å¿—ç›®å½•: $LOG_DIR${NC}"
}

# æœåŠ¡ç®¡ç†
manage_services() {
    local action=$1
    local options=$2
    
    case "$action" in
        "start")
            echo -e "${BLUE}ğŸš€ å¯åŠ¨Robot Studioå®Œæ•´ç³»ç»Ÿ...${NC}"

            # 1. å¯åŠ¨åº•ç›˜æ§åˆ¶èŠ‚ç‚¹
            echo -e "${YELLOW}1. å¯åŠ¨æœºå™¨äººæ§åˆ¶èŠ‚ç‚¹...${NC}"
            start_robot_control

            # 2. å¯åŠ¨SLAMèŠ‚ç‚¹
            echo -e "${YELLOW}2. å¯åŠ¨SLAMå’Œä¼ æ„Ÿå™¨èŠ‚ç‚¹...${NC}"
            start_slam_nodes

            # 3. å¯åŠ¨WebæœåŠ¡
            echo -e "${YELLOW}3. å¯åŠ¨WebæœåŠ¡å’ŒWebSocketæ¡¥æ¥...${NC}"
            start_web_services
            
            # 4. WiFiçƒ­ç‚¹ï¼ˆæŒ‰éœ€æ‰‹åŠ¨ï¼Œé¿å…ç½‘ç»œä¸­æ–­ï¼‰
            echo -e "${YELLOW}4. WiFiçƒ­ç‚¹ï¼ˆå¯é€‰ï¼‰...${NC}"
            if [ "$options" = "--hotspot" ] || [ "$options" = "hotspot" ]; then
                echo -e "${CYAN}ğŸ”„ æ‰‹åŠ¨å¯åŠ¨WiFiçƒ­ç‚¹æ¨¡å¼...${NC}"
                ./improved_hotspot.sh start
                if [ $? -eq 0 ]; then
                    echo "    âœ… WiFiçƒ­ç‚¹å·²å¯åŠ¨"
                else
                    echo "    âŒ WiFiçƒ­ç‚¹å¯åŠ¨å¤±è´¥"
                fi
            else
                echo -e "${YELLOW}ğŸ’¡ ä¸ºé¿å…ç½‘ç»œæ–­å¼€ï¼Œstart/stop é»˜è®¤ä¸è‡ªåŠ¨å¼€å¯/å…³é—­çƒ­ç‚¹${NC}"
                echo -e "${YELLOW}   å¦‚éœ€çƒ­ç‚¹ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œ: $0 hotspot${NC}"
            fi
            
            echo ""
            
            # å¿«é€Ÿæ£€æŸ¥æœåŠ¡å¯åŠ¨çŠ¶æ€ï¼ˆè·³è¿‡è¯¦ç»†éªŒè¯ï¼‰
            echo -e "${YELLOW}5. å¿«é€Ÿæ£€æŸ¥æœåŠ¡çŠ¶æ€...${NC}"
            sleep 2

            # æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬ï¼ˆä½¿ç”¨sså‘½ä»¤ï¼Œæ›´å¯é ï¼‰
            local services_count=0
            local port_status=""

            for port in 8000 8080 8001; do
                if ss -tuln | grep -q ":$port "; then
                    ((services_count++))
                    port_status="$port_status  âœ… ç«¯å£ $port å·²ç›‘å¬\n"
                else
                    port_status="$port_status  âŒ ç«¯å£ $port æœªç›‘å¬\n"
                fi
            done

            echo -e "$port_status"
            echo "  æ£€æµ‹åˆ° $services_count/3 ä¸ªæœåŠ¡ç«¯å£å·²å¯åŠ¨"

            # æ³¨æ„ï¼šä¸ºé¿å…å½±å“ç½‘ç»œè¿æ¥ï¼Œè¿™é‡Œä¸å†è‡ªåŠ¨ä¿®æ”¹çƒ­ç‚¹/ç½‘å¡é…ç½®
            
            echo ""
            if [ $services_count -eq 3 ]; then
                echo -e "${GREEN}âœ… Robot Studioå®Œæ•´ç³»ç»Ÿå¯åŠ¨å®Œæˆ${NC}"
            else
                echo -e "${YELLOW}âš ï¸ Robot Studio å¯åŠ¨æœªå®Œæ•´ï¼ˆ$services_count/3 ç«¯å£å·²ç›‘å¬ï¼‰ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ’æŸ¥${NC}"
            fi
            echo ""
            echo -e "${PURPLE}ğŸ“± è®¿é—®æ–¹å¼ï¼š${NC}"
            local access_ip
            access_ip=$(ip -4 -o addr show wlP1p1s0 2>/dev/null | awk '{print $4}' | cut -d/ -f1 | head -n 1)
            if [ -z "$access_ip" ]; then
                access_ip=$(hostname -I | awk '{print $1}')
            fi

            echo "  æœºå™¨äººæœ¬æœºè®¿é—®: http://localhost:8080 (ä»…åœ¨æœºå™¨äººæœ¬æœºæµè§ˆå™¨ä½¿ç”¨)"
            echo "  å…¶ä»–è®¾å¤‡è®¿é—®: http://$access_ip:8080 (ä¸è¦åœ¨å…¶ä»–è®¾å¤‡ä½¿ç”¨ localhost)"
            if pgrep hostapd >/dev/null 2>&1 && pgrep dnsmasq >/dev/null 2>&1; then
                echo "  WiFiçƒ­ç‚¹è®¿é—®: http://robot æˆ– http://192.168.4.1:8080"
                echo "  çƒ­ç‚¹APIè®¿é—®: http://192.168.4.1:8000"
                echo "  çƒ­ç‚¹WebSocket: ws://192.168.4.1:8001"
                echo -e "${GREEN}  ğŸ“¶ WiFiçƒ­ç‚¹ 'RobotStudio' å·²å¯ç”¨ (æ— å¯†ç )${NC}"
            fi
            echo ""
            echo -e "${CYAN}ğŸ® åŠŸèƒ½è¯´æ˜ï¼š${NC}"
            echo "  â€¢ Webç•Œé¢å·²å¯åŠ¨ï¼Œæ”¯æŒè™šæ‹Ÿæ‘‡æ†æ§åˆ¶"
            echo "  â€¢ åº•ç›˜æ§åˆ¶èŠ‚ç‚¹å·²å¯åŠ¨ï¼Œæ‘‡æ†æ§åˆ¶å¯ç”¨"
            echo "  â€¢ APIæœåŠ¡å™¨å·²å¯åŠ¨ï¼Œæ”¯æŒç¨‹åºæ§åˆ¶å’Œå½•åˆ¶åŠŸèƒ½"
            echo "  â€¢ WebSocketæ¡¥æ¥å·²å¯åŠ¨ï¼Œæ”¯æŒå®æ—¶åœ°å›¾å’Œæ¿€å…‰é›·è¾¾æ•°æ®"
            echo "  â€¢ Aurora LIDARå·²å¯åŠ¨ï¼Œæä¾›SLAMåœ°å›¾å’Œç‚¹äº‘æ•°æ®"
            echo "  â€¢ åœ°å›¾æ˜¾ç¤ºåŠŸèƒ½å·²å°±ç»ªï¼Œå¯åœ¨Webç•Œé¢æŸ¥çœ‹å®æ—¶åœ°å›¾"
            echo ""
            echo -e "${CYAN}ï¿½ æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š${NC}"
            LOG_DIR="$HOME/.robot-studio/logs"
            echo "  â€¢ æ‰€æœ‰æ—¥å¿—: $LOG_DIR/"
            echo "  â€¢ APIæœåŠ¡å™¨: tail -f $LOG_DIR/api_server.log"
            echo "  â€¢ WebSocketæ¡¥æ¥: tail -f $LOG_DIR/websocket.log"
            echo "  â€¢ WebæœåŠ¡å™¨: tail -f $LOG_DIR/web_server.log"
            echo "  â€¢ Aurora SDK: tail -f $LOG_DIR/aurora_sdk.log"
            echo "  â€¢ åº•ç›˜æ§åˆ¶: tail -f $LOG_DIR/ackermann_controller.log"
            echo ""
            echo -e "${CYAN}ğŸ”§ å¸¸ç”¨å‘½ä»¤ï¼š${NC}"
            echo "  â€¢ æŸ¥çœ‹çŠ¶æ€: ./robot-studio status"
            echo "  â€¢ æŸ¥çœ‹æ—¥å¿—: ./robot-studio logs"
            echo "  â€¢ æ£€æŸ¥ROS2è¯é¢˜: ros2 topic list | grep slamware"
            echo "  â€¢ åœæ­¢ç³»ç»Ÿ: ./robot-studio stop"
            echo ""
            echo -e "${YELLOW}ğŸ’¡ æç¤ºï¼šå¦‚æœæœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶è¿›è¡Œè¯Šæ–­${NC}"
            ;;
        "stop")
            echo -e "${YELLOW}ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡...${NC}"

            local sudo_cmd=""
            if [ "$(id -u)" -ne 0 ]; then
                if sudo -n true >/dev/null 2>&1; then
                    sudo_cmd="sudo -n"
                elif [ -t 0 ]; then
                    echo -e "${YELLOW}â„¹ï¸  éœ€è¦ sudo æƒé™ä»¥æ¸…ç† root è¿›ç¨‹ï¼Œå¯èƒ½ä¼šæç¤ºè¾“å…¥å¯†ç ${NC}"
                    sudo_cmd="sudo"
                fi
            fi

            kill_by_pattern() {
                local pattern="$1"

                pkill -f "$pattern" 2>/dev/null || true

                if [ -n "$sudo_cmd" ]; then
                    $sudo_cmd pkill -f "$pattern" 2>/dev/null || true
                fi
            }

            # åœæ­¢ç½‘ç»œæœåŠ¡ï¼ˆåŒ…æ‹¬rootç”¨æˆ·çš„è¿›ç¨‹ï¼‰
            echo "  åœæ­¢ç½‘ç»œæœåŠ¡..."
            kill_by_pattern "python3.*robot_api_server"

            kill_by_pattern "python3.*ros2_web_bridge"

            kill_by_pattern "python3 -m http.server 8080"
            kill_by_pattern "web_interface_server.py.*--port 8080"

            # åœæ­¢bashåŒ…è£…è¿›ç¨‹
            kill_by_pattern "bash -c.*robot_api_server"
            kill_by_pattern "bash -c.*ros2_web_bridge"

            sleep 1

            # åœæ­¢åº•ç›˜æ§åˆ¶èŠ‚ç‚¹
            echo "  åœæ­¢åº•ç›˜æ§åˆ¶èŠ‚ç‚¹..."
            kill_by_pattern "unified_ackermann_controller"

            kill_by_pattern "topic_relay_node"
            kill_by_pattern "robot_static_tf.launch.py"
            kill_by_pattern "hardware_interface.launch.py"

            # åœæ­¢SLAMèŠ‚ç‚¹
            echo "  åœæ­¢SLAMèŠ‚ç‚¹..."
            kill_by_pattern "slamware_ros_sdk_server_node.py"

            sleep 1

            # æ³¨æ„ï¼šä¸ºé¿å…å½±å“ç½‘ç»œè¿æ¥ï¼Œè¿™é‡Œä¸å†è‡ªåŠ¨åœæ­¢WiFiçƒ­ç‚¹
            # å¦‚éœ€åœæ­¢çƒ­ç‚¹ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œï¼š./robot-studio hotspot-stop

            # éªŒè¯åœæ­¢ç»“æœ
            sleep 1
            local remaining=$(ps aux | grep -E "(robot_api_server|ros2_web_bridge|http.server 8080)" | grep -v grep | wc -l)
            if [ $remaining -eq 0 ]; then
                echo -e "${GREEN}âœ… æ‰€æœ‰æœåŠ¡å·²å®Œå…¨åœæ­¢${NC}"
            else
                echo -e "${YELLOW}âš ï¸  ä»æœ‰ $remaining ä¸ªè¿›ç¨‹åœ¨è¿è¡Œï¼Œå°è¯•å¼ºåˆ¶ç»ˆæ­¢...${NC}"

                # è·å–æ‰€æœ‰ç›¸å…³è¿›ç¨‹çš„PID
                local pids=$(ps aux | grep -E "(robot_api_server|ros2_web_bridge|http.server 8080)" | grep -v grep | awk '{print $2}')

                if [ -n "$pids" ]; then
                    echo "  å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹: $pids"
                    kill -9 $pids 2>/dev/null || true
                    if [ -n "$sudo_cmd" ]; then
                        $sudo_cmd kill -9 $pids 2>/dev/null || true
                    fi
                    sleep 1

                    # å†æ¬¡éªŒè¯
                    remaining=$(ps aux | grep -E "(robot_api_server|ros2_web_bridge|http.server 8080)" | grep -v grep | wc -l)
                    if [ $remaining -eq 0 ]; then
                        echo -e "${GREEN}âœ… æ‰€æœ‰æœåŠ¡å·²å®Œå…¨åœæ­¢${NC}"
                    else
                        echo -e "${RED}âŒ ä»æœ‰è¿›ç¨‹æ— æ³•åœæ­¢ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥${NC}"
                        ps aux | grep -E "(robot_api_server|ros2_web_bridge|http.server)" | grep -v grep
                    fi
                fi
            fi
            ;;
        "restart")
            manage_services "stop"
            sleep 3
            manage_services "start" "$options"
            ;;
        "status")
            ./service_monitor.sh status
            ;;
    esac
}

# ç½‘ç»œç®¡ç†
manage_network() {
    local action=$1
    
    case "$action" in
        "network")
            ./network_manager.sh status
            ;;
        "hotspot")
            echo -e "${BLUE}ğŸ“¡ å¯ç”¨WiFiçƒ­ç‚¹...${NC}"
            ./improved_hotspot.sh start
            ;;
        "hotspot-stop")
            echo -e "${YELLOW}ğŸ›‘ åœæ­¢WiFiçƒ­ç‚¹...${NC}"
            ./improved_hotspot.sh stop
            ;;
    esac
}

# ç›‘æ§ç®¡ç†
manage_monitoring() {
    local action=$1
    
    case "$action" in
        "start")
            ./service_monitor.sh start
            ;;
        "stop")
            ./service_monitor.sh stop
            ;;
        "status")
            ./service_monitor.sh status
            ;;
    esac
}

# æ˜¾ç¤ºæ—¥å¿—
show_logs() {
    echo -e "${CYAN}=== Robot Studio ç³»ç»Ÿæ—¥å¿— ===${NC}"
    echo ""

    LOG_DIR="$HOME/.robot-studio/logs"

    # æ£€æŸ¥æ—¥å¿—ç›®å½•
    if [ ! -d "$LOG_DIR" ]; then
        echo -e "${YELLOW}æ—¥å¿—ç›®å½•ä¸å­˜åœ¨: $LOG_DIR${NC}"
        echo "ç³»ç»Ÿå¯èƒ½è¿˜æœªå¯åŠ¨è¿‡ï¼Œæˆ–ä½¿ç”¨æ—§çš„æ—¥å¿—ä½ç½® /tmp/"
        echo ""
        LOG_DIR="/tmp"
    fi

    echo -e "${BLUE}æ—¥å¿—ç›®å½•: $LOG_DIR${NC}"
    echo ""

    # æ˜¾ç¤ºå„ä¸ªæœåŠ¡çš„æ—¥å¿—
    local logs=(
        "api_server.log:APIæœåŠ¡å™¨"
        "websocket.log:WebSocketæ¡¥æ¥"
        "web_server.log:WebæœåŠ¡å™¨"
        "aurora_sdk.log:Aurora SDK"
        "ackermann_controller.log:åº•ç›˜æ§åˆ¶å™¨"
        "robot_model.log:æœºå™¨äººæ¨¡å‹"
        "topic_relay.log:è¯é¢˜ä¸­ç»§"
        "hardware_interface.log:ç¡¬ä»¶æ¥å£"
    )

    for log_entry in "${logs[@]}"; do
        IFS=':' read -r log_file log_name <<< "$log_entry"
        echo -e "${YELLOW}â”â”â” $log_name ($log_file) â”â”â”${NC}"

        if [ -f "$LOG_DIR/$log_file" ]; then
            echo -e "${CYAN}æœ€å15è¡Œ:${NC}"
            tail -15 "$LOG_DIR/$log_file" | sed 's/^/  /'
        else
            echo -e "${RED}  æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨${NC}"
        fi
        echo ""
    done

    echo -e "${CYAN}ğŸ’¡ æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼š${NC}"
    echo "  tail -f $LOG_DIR/api_server.log"
    echo "  tail -f $LOG_DIR/websocket.log"
    echo "  tail -f $LOG_DIR/aurora_sdk.log"
}

# å¥åº·æ£€æŸ¥
health_check() {
    echo -e "${PURPLE}ğŸ¥ Robot Studio ç³»ç»Ÿå¥åº·æ£€æŸ¥${NC}"
    echo ""
    
    local health_score=0
    local total_checks=6
    
    # 1. æ£€æŸ¥ç½‘ç»œè¿æ¥
    echo -e "${BLUE}1. ç½‘ç»œè¿æ¥æ£€æŸ¥...${NC}"
    if ping -c 1 -W 3 8.8.8.8 >/dev/null 2>&1; then
        echo -e "   äº’è”ç½‘è¿æ¥: ${GREEN}âœ… æ­£å¸¸${NC}"
        ((health_score++))
    else
        echo -e "   äº’è”ç½‘è¿æ¥: ${RED}âŒ å¼‚å¸¸${NC}"
    fi
    
    # 2. æ£€æŸ¥ROS2ç¯å¢ƒ
    echo -e "${BLUE}2. ROS2ç¯å¢ƒæ£€æŸ¥...${NC}"
    if [ -f "/opt/ros/humble/setup.bash" ]; then
        echo -e "   ROS2 Humble: ${GREEN}âœ… å·²å®‰è£…${NC}"
        ((health_score++))
    else
        echo -e "   ROS2 Humble: ${RED}âŒ æœªå®‰è£…${NC}"
    fi
    
    # 3. æ£€æŸ¥æ ¸å¿ƒæœåŠ¡
    echo -e "${BLUE}3. æ ¸å¿ƒæœåŠ¡æ£€æŸ¥...${NC}"
    local services_running=0
    for port in 8000 8001 8080; do
        if lsof -i :$port > /dev/null 2>&1; then
            ((services_running++))
        fi
    done
    
    if [ $services_running -eq 3 ]; then
        echo -e "   æ ¸å¿ƒæœåŠ¡: ${GREEN}âœ… å…¨éƒ¨è¿è¡Œ (3/3)${NC}"
        ((health_score++))
    elif [ $services_running -gt 0 ]; then
        echo -e "   æ ¸å¿ƒæœåŠ¡: ${YELLOW}âš ï¸ éƒ¨åˆ†è¿è¡Œ ($services_running/3)${NC}"
    else
        echo -e "   æ ¸å¿ƒæœåŠ¡: ${RED}âŒ æœªè¿è¡Œ (0/3)${NC}"
    fi
    
    # 4. æ£€æŸ¥ç³»ç»Ÿèµ„æº
    echo -e "${BLUE}4. ç³»ç»Ÿèµ„æºæ£€æŸ¥...${NC}"
    local mem_usage=$(free | grep Mem | awk '{printf("%.1f"), $3/$2 * 100.0}')
    if (( $(echo "$mem_usage < 90.0" | bc -l) )); then
        echo -e "   å†…å­˜ä½¿ç”¨: ${GREEN}âœ… æ­£å¸¸ (${mem_usage}%)${NC}"
        ((health_score++))
    else
        echo -e "   å†…å­˜ä½¿ç”¨: ${RED}âŒ è¿‡é«˜ (${mem_usage}%)${NC}"
    fi
    
    # 5. æ£€æŸ¥ç£ç›˜ç©ºé—´
    echo -e "${BLUE}5. ç£ç›˜ç©ºé—´æ£€æŸ¥...${NC}"
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ "$disk_usage" -lt 85 ]; then
        echo -e "   ç£ç›˜ç©ºé—´: ${GREEN}âœ… å……è¶³ (${disk_usage}% å·²ä½¿ç”¨)${NC}"
        ((health_score++))
    else
        echo -e "   ç£ç›˜ç©ºé—´: ${RED}âŒ ä¸è¶³ (${disk_usage}% å·²ä½¿ç”¨)${NC}"
    fi
    
    # 6. æ£€æŸ¥é‡è¦æ–‡ä»¶
    echo -e "${BLUE}6. é‡è¦æ–‡ä»¶æ£€æŸ¥...${NC}"
    local files_exist=0
    local important_files=("robot_api_server.py" "ros2_web_bridge.py" "web_interface/index.html")
    
    for file in "${important_files[@]}"; do
        if [ -f "$SCRIPT_DIR/$file" ]; then
            ((files_exist++))
        fi
    done
    
    if [ $files_exist -eq ${#important_files[@]} ]; then
        echo -e "   é‡è¦æ–‡ä»¶: ${GREEN}âœ… å®Œæ•´ ($files_exist/${#important_files[@]})${NC}"
        ((health_score++))
    else
        echo -e "   é‡è¦æ–‡ä»¶: ${RED}âŒ ç¼ºå¤± ($files_exist/${#important_files[@]})${NC}"
    fi
    
    # è®¡ç®—å¥åº·åˆ†æ•°
    echo ""
    local health_percentage=$((health_score * 100 / total_checks))
    
    if [ $health_percentage -ge 90 ]; then
        echo -e "${GREEN}ğŸ‰ ç³»ç»Ÿå¥åº·çŠ¶å†µ: ä¼˜ç§€ ($health_percentage/100)${NC}"
    elif [ $health_percentage -ge 70 ]; then
        echo -e "${YELLOW}âš ï¸  ç³»ç»Ÿå¥åº·çŠ¶å†µ: è‰¯å¥½ ($health_percentage/100)${NC}"
    elif [ $health_percentage -ge 50 ]; then
        echo -e "${YELLOW}âš ï¸  ç³»ç»Ÿå¥åº·çŠ¶å†µ: ä¸€èˆ¬ ($health_percentage/100)${NC}"
    else
        echo -e "${RED}âŒ ç³»ç»Ÿå¥åº·çŠ¶å†µ: éœ€è¦å…³æ³¨ ($health_percentage/100)${NC}"
    fi
    
    # æä¾›å»ºè®®
    if [ $health_percentage -lt 100 ]; then
        echo ""
        echo -e "${CYAN}ğŸ’¡ æ”¹è¿›å»ºè®®:${NC}"
        if [ $services_running -lt 3 ]; then
            echo "  - å¯åŠ¨ç¼ºå¤±çš„æœåŠ¡: robot-studio start"
        fi
        if (( $(echo "$mem_usage >= 90.0" | bc -l) )); then
            echo "  - æ¸…ç†å†…å­˜: sudo systemctl restart"
        fi
        if [ "$disk_usage" -ge 85 ]; then
            echo "  - æ¸…ç†ç£ç›˜: robot-studio cleanup"
        fi
    fi
}

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
cleanup_system() {
    echo -e "${BLUE}ğŸ§¹ æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶...${NC}"
    
    local cleaned_files=0
    
    # æ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼ˆä¿ç•™æœ€æ–°1000è¡Œï¼‰
    for log_file in "/tmp/api_server.log" "/tmp/websocket.log" "/tmp/service_monitor.log"; do
        if [ -f "$log_file" ] && [ $(wc -l < "$log_file") -gt 1000 ]; then
            tail -1000 "$log_file" > "${log_file}.tmp"
            mv "${log_file}.tmp" "$log_file"
            ((cleaned_files++))
            echo "  æ¸…ç†æ—¥å¿—: $(basename $log_file)"
        fi
    done
    
    # æ¸…ç†PIDæ–‡ä»¶
    for pid_file in /tmp/*.pid; do
        if [ -f "$pid_file" ]; then
            local pid=$(cat "$pid_file" 2>/dev/null)
            if [ ! -z "$pid" ] && ! ps -p "$pid" > /dev/null 2>&1; then
                rm -f "$pid_file"
                ((cleaned_files++))
                echo "  æ¸…ç†PIDæ–‡ä»¶: $(basename $pid_file)"
            fi
        fi
    done
    
    # æ¸…ç†é‡å¯è®¡æ•°æ–‡ä»¶
    for restart_file in /tmp/*_restart_count; do
        if [ -f "$restart_file" ]; then
            rm -f "$restart_file"
            ((cleaned_files++))
            echo "  æ¸…ç†é‡å¯è®¡æ•°: $(basename $restart_file)"
        fi
    done
    
    echo -e "${GREEN}âœ… æ¸…ç†å®Œæˆï¼Œå…±å¤„ç† $cleaned_files ä¸ªæ–‡ä»¶${NC}"
}

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
show_version() {
    show_banner
    echo -e "${CYAN}ç‰ˆæœ¬ä¿¡æ¯:${NC}"
    echo "  Robot Studio System Manager: v$VERSION"
    echo "  ROS2: $([ -f /opt/ros/humble/setup.bash ] && echo 'Humble' || echo 'æœªå®‰è£…')"
    echo "  Python: $(python3 --version 2>/dev/null || echo 'æœªå®‰è£…')"
    echo "  ç³»ç»Ÿ: $(uname -sr)"
    echo "  æ¶æ„: $(uname -m)"
    echo ""
    echo -e "${CYAN}ç»„ä»¶çŠ¶æ€:${NC}"

    local components=("improved_hotspot.sh" "service_monitor.sh" "network_manager.sh" "start_robot_studio.sh" "stop_robot_studio.sh")
    for component in "${components[@]}"; do
        if [ -x "$SCRIPT_DIR/$component" ]; then
            echo -e "  $component: ${GREEN}âœ… å¯ç”¨${NC}"
        else
            echo -e "  $component: ${RED}âŒ ç¼ºå¤±${NC}"
        fi
    done
}

# ä¸»å‡½æ•°
main() {
    # åˆ‡æ¢åˆ°è„šæœ¬ç›®å½•
    cd "$SCRIPT_DIR" || {
        echo -e "${RED}é”™è¯¯: æ— æ³•åˆ‡æ¢åˆ°å·¥ä½œç›®å½• $SCRIPT_DIR${NC}"
        exit 1
    }
    
    # æ£€æŸ¥ä¾èµ–
    if ! check_dependencies; then
        exit 1
    fi
    
    case "$1" in
        "start")
            manage_services "start" "$2"
            ;;
        "stop")
            manage_services "stop"
            ;;
        "restart")
            manage_services "restart" "$2"
            ;;
        "status")
            manage_services "status"
            ;;
        "network")
            manage_network "network"
            ;;
        "hotspot")
            manage_network "hotspot"
            ;;
        "hotspot-stop")
            manage_network "hotspot-stop"
            ;;
        "monitor")
            manage_monitoring "$2"
            ;;
        "logs")
            show_logs
            ;;
        "health")
            health_check
            ;;
        "cleanup")
            cleanup_system
            ;;
        "version")
            show_version
            ;;
        "help"|"--help"|"-h"|"")
            show_help
            ;;
        *)
            echo -e "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}"
            echo "ä½¿ç”¨ '$0 help' æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯"
            exit 1
            ;;
    esac
}

main "$@"
